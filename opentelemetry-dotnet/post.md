# OpenTelemetry .NET

Содержание:
1. Вступление
    - Описание OTEL
    - Мотивация
2. Сравнение OTEL и DiagnosticSource
    - Таблица сравнения
3. Трейсинг с помощью DiagnosticSource
    - Создание источника
    - Создание активности
    - Добавление тега
    - Добавление события
    - Изменение статуса
    - Использование `Tracer`
4. Подключение библиотеки и настройка в `ASP.NET Core`
    - Настройка окружения (название приложения, версия, тэги процесса)
        - Константы
        - `Detector`
        - Встроенные детекторы переменных окружения
    - Добавление инструментаторов
    - Добавление собственных источников
    - Несколько экспортеров
5. Рецепты:
    - Синхронный запрос от одного сервиса к другому по HTTP
    - Проброс контекста между различными приложениями - (`PropagationContext`, `Propagators`)
    - Добавление тегов в существующую `Activity` (`Activity.Current`)
    - Дробление большого запроса на несколько

## Сравнение OpenTelemetry и System.Diagnostics

Начиная с .NET 5 были добавлены типы, которые позволяют производить трейсинг работы приложения без необходимости подключения дополнительных библиотек. Речь о `Activity`, `ActivitySource`, `ActivityListener`. Они коррелируют с понятиями определенными в OpenTelemetry

|.NET|OpenTelemetry|Комментарий|
|-|-|-|
|Activity|Span|Операция, производимая приложением (бизнес-логика, запросы)|
|ActivitySource|Tracer|Создатель Activity/Span|
|Tag|Attribute|Метаданные спана/операции|
|ActivityKind|SpanKind|Взаимоотношения между зависимыми спанами|
|ActivityContext|SpanContext|Контекст выполнения, который можно передать в другие спаны|
|ActivityLink|Link|Ссылка на другой спан|

Для приведения к единому знаменателю в OpenTelemetry добавили обертки вокруг System.Diagnostics, который работает с понятиями из OpenTelemetry. Эти типы объединены под одним понятием `Tracing shim`

|System.Diagnostics|Tracing shim|
|-|-|
|Activity|TelemetrySpan|
|ActivitySource|Tracer|
|ActivityContext|SpanContext|

Но все же, создатели библиотеки рекомендуют пользоваться `System.Diagnostics` вместо `Tracing shim`. Дальше буду использовать `System.Diagnostics`

[Таблица сравнений](https://gist.github.com/lmolkova/6cd1f61f70dd45c0c61255сравнение039695cce8)

## Трейсинг в System.Diagnostics

Для трейсинга в .NET используется Activity API, предоставляемый `System.Diagnostics`.

Алгоритм работы с ним следующий:

1. Определяем источник событий: `ActivitySource`
```csharp
// TODO
```

2. В интересуемой операции создаем начинаем отслеживание новой активности
```csharp
// TODO
```

3. Добавляем метаданные
```csharp
// TODO
```

4. Заканчиваем событие
```csharp
// TODO
```

Как полученная информация обрабатывается - лежит на `ActivityListener`, но это ~~уже другая история~~ делает подключеная библиотека.

Лайфхаки/замечания:
- Метод `StartActivity` может вернуть `null`, если никто не подписан на событие. *При всех вызовах методов нужно делать проверку на `null`*
- `Activity` реализует `IDisposable`. *Можно не вызывать `Stop` вручную, а использовать `using`*
- `Activity` позволяет делать записи о пользовательских событиях: `activity.AddEvent(new ActivityEvent("Что-то случилось"))`. Дополнительно в библиотеке есть метод расширения для записи исключений: `activity.RecordException(ex)`
- Раз мы можем кидать/записывать исключения, то надо уметь отслеживать место, где исключение было брошено. Для этого можно выставить статус спана: `activity.SetStatus(ActivityStatusCode.Error, ex.Message)`. Под капотом, `activity.RecordException(ex)` работает через этот метод. (Кроме `Error` есть `Ok` и `Unset`)
- У каждой активности есть `Baggage` - коллекция ассоциированных с операцией данных. Разница в том, что `Baggage` может использоваться логикой приложения и передается между контекстами (сериализуется), а `Tag` - это просто метаданные для расследования инцидентов. Доступ ведется через одноименное свойство: `activity.Baggage`

Вот пример полного пути выполнения:
```csharp
```

## Подключение OpenTelemetry

- Многие в prerelease
- Перечисление необходимых библиотек
- Подключение OpenTelemetry()
- Подключение WithTracing()
- Что такое Resource (+ AddService, Detector)
- Что такое Instrumentator
- Что такое Exporter
- 
