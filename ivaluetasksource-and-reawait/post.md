Содержание:
1. ValueTask до и после .NET Core 2.1 - добавление IValueTaskSource
2. Устройство и алгоритм работы IValueTaskSource
3. Делаем полностью своими руками
4. Добавляем ManualResetValueTaskSource
5. Как реализован сокет с помощью него (все делают пример на нем, я не исключение)
6. Бенчмарки?
7. Ссылки

# ValueTask до и после .NET Core 2.1

Для оптимизации памяти был добавлен ValueTask.
Но жадным программистам и этого оказалось мало. 
Добавили IValueTaskSource
Новый конструктор

# Устройство и алгоритм работы IValueTaskSource

Определение интерфейса

За что каждый метод отвечает.

Алгоритм их работы (последовательность вызова из ValueTask).

Добавить ссылку на [гитхаб](https://github.com/dotnet/runtime/blob/main/src/libraries/System.Private.CoreLib/src/System/Threading/Tasks/Sources/IValueTaskSource.cs) IValueTaskSource 

# Делаем полностью своими руками

Постановка задачи `PcMonitor`
Алгоритм работы с `PcMonitor`

Создание класса.

Реализация GetResult()

Реализация GetStatus()

Реализация OnCompletion()

Добавляем комментарии в вызовы методов для проверки пути вызова

# Добавляем ManualResetValueTaskSource

Реализация по большей части шаблонная.

Многая реализация уже есть в `ManualResetValueTaskSource`

Как выглядит с ним

# Добавляем пулинг + почему нельзя заново await'ить

Наши реализации можно переиспользовать.

Это пулинг

Использую Microsoft.Extensions.ObjectPool

Когда берем (в GetResult) и когда возвращаем

GetResult() 1 раз!! поэтому возвращаем в пул здесь.

Если сделать await заново, то передастся другой токен и мы заметим

# Как реализован сокет с помощью него (все делают пример на нем, я не исключение)

`IValueTaskSource` (как говорят) был добавлен специально для сокетов.
Все делают примеры на нем - я не исключение.

Реализация -  `AwaitableSocketsEventArgs`

Пример на ReceiveAsync.
Используется один буфер, т.к. чтение только 1 потоком возможно.
Строка 307

Строка 953 - если операция не завершилась - передача самого себя

Внутри все доходит до нативной операции и происходит возврат

Внутри `SocketAsyncEventArgs` (базовом классе) есть переменные для каждой возможной операции.
Начало класса

Сделать аналогию с нашей реализацией

# Бенчмарки?

Сравнение памяти ValueTask и Task

# Полезные ссылки

- Мой проект
- Реализация сокета (гитхаб)
- 

